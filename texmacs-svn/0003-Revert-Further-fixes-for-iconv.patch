From c858ebcbd9de4a82116e49d9c7fd2fd3a6f1b5f4 Mon Sep 17 00:00:00 2001
From: wangjiezhe <wangjiezhe@gmail.com>
Date: Sat, 11 Jun 2016 17:40:28 +0800
Subject: [PATCH 3/4] Revert "Further fixes for iconv"

This reverts commit 9caa8ff5de8642d84bcc445c0248a7f645307fff.
---
 aclocal.m4       | 10 +++-----
 configure        | 70 ++++++++++++++++++++++++++++++--------------------------
 misc/m4/iconv.m4 | 15 ++++++------
 3 files changed, 48 insertions(+), 47 deletions(-)

diff --git a/aclocal.m4 b/aclocal.m4
index 7ff3475..8b32f52 100644
--- a/aclocal.m4
+++ b/aclocal.m4
@@ -108,12 +108,8 @@ m4_define([LC_POP_FLAG],[m4_define([GETPOP],[%]) LC_GETPOP_FLAG([$1],[$2],[$3])]
 # wrapping AC_?_IFELSE for erro smg
 AC_DEFUN([LC_X_IFELSE],[
   AC_MSG_CHECKING([$2] linking)
-  AC_$1_IFELSE([$3], [ 
-    AC_MSG_RESULT(yes) 
-    $4
-  ],[ 
-    AC_MSG_RESULT(no) 
-    $5
+  AC_$1_IFELSE([$3], [ AC_MSG_RESULT(yes) $4
+  ],[ AC_MSG_RESULT(no) $5
   ])])
 AC_DEFUN([LC_RUN_IFELSE],[LC_X_IFELSE([RUN],[$1],[$2],[$3],[$4],[$5])])
 AC_DEFUN([LC_LINK_IFELSE],[LC_X_IFELSE([LINK],[$1],[$2],[$3],[$4],[$5])])
@@ -194,7 +190,7 @@ AC_DEFUN([_LC_TRANSFERT_FLAGS],
 # set compile flags from the LIBRARY ($1) flags into standard flags
 # in order to test static linking set the -static if needed
 AC_DEFUN([LC_SET_FLAGS],[
-  _LC_TRANSFERT_FLAGS([$1],[superseded_flags,[LIBS]],[LDFLAGS])
+  _LC_TRANSFERT_FLAGS([$1],[superseded_flags],[LDFLAGS])
   if test -n "$LNSTATIC"
   then LC_APPEND_FLAG([-static], [CFLAGS])
        LC_APPEND_FLAG([-static], [CXXFLAGS])
diff --git a/configure b/configure
index 6ba59c7..93f6484 100755
--- a/configure
+++ b/configure
@@ -5544,7 +5544,7 @@ _ACEOF
 
 
 
-   if [ "$GUILE_CFLAGS" ]; then CFLAGS=$GUILE_CFLAGS;fi; if [ "$GUILE_CXXFLAGS" ]; then CXXFLAGS=$GUILE_CXXFLAGS;fi; if [ "$GUILE_CPPFLAGS" ]; then CPPFLAGS=$GUILE_CPPFLAGS;fi; if [ "$GUILE_LIBS" ]; then LIBS=$GUILE_LIBS;fi;
+   if [ "$GUILE_CFLAGS" ]; then CFLAGS=$GUILE_CFLAGS;fi; if [ "$GUILE_CXXFLAGS" ]; then CXXFLAGS=$GUILE_CXXFLAGS;fi; if [ "$GUILE_CPPFLAGS" ]; then CPPFLAGS=$GUILE_CPPFLAGS;fi;
 
   LC_MERGE_FLAGS_list="$GUILE_LDFLAGS"
   if [[ "LDFLAGS" =~ $(echo "(^|_)LIBS") ]]
@@ -6942,10 +6942,8 @@ main ()
 }
 _ACEOF
 if ac_fn_cxx_try_link "$LINENO"; then :
-
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+   { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
 $as_echo "yes" >&6; }
-
         g_success=1
 
   { $as_echo "$as_me:${as_lineno-$LINENO}: checking Guile DOTS linking" >&5
@@ -6976,20 +6974,16 @@ main ()
 }
 _ACEOF
 if ac_fn_cxx_try_run "$LINENO"; then :
-
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+   { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
 $as_echo "yes" >&6; }
 
-
 $as_echo "#define DOTS_OK 1" >>confdefs.h
 
 
 
 else
-
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
-
 #         LC_MERGE_FLAGS([-fpermissive],[CXXFLAGS])
 #         LC_RUN_IFELSE([Guile DOTS with -fpermissive], [LM_GUILE_DOTS],[
 #         LC_MERGE_FLAGS([-fpermissive],[GUILE_CXXFLAGS])
@@ -7049,11 +7043,9 @@ fi
 
 
 else
-
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
 
-
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
@@ -10086,7 +10078,6 @@ then
 
 
 
-  # try to find a header somewhere in this path and ask for its location
   CPPFLAGS="${LC_ICONV_PATH//-L/-I} -I$withval/include -I/opt/local/include -I/sw/include -MM -MF $LC_ICONV_TEMP"
 
 
@@ -10099,7 +10090,29 @@ if test "x$ac_cv_header_iconv_h" = xyes; then :
     LC_ICONV_ICONV=${LC_ICONV_DEPEND%/include/iconv.h*}
     if  [[ "$LC_ICONV_DEPEND" == "$LC_ICONV_ICONV" ]]
     then
-      # don't add the default path to the LDFLAGS
+
+  CFLAGS=$CFLAGS__ax_save_flags
+
+
+  CPPFLAGS=$CPPFLAGS__ax_save_flags
+
+
+  CXXFLAGS=$CXXFLAGS__ax_save_flags
+
+
+  LDFLAGS=$LDFLAGS__ax_save_flags
+
+
+  LIBS=$LIBS__ax_save_flags
+
+
+  OBJCFLAGS=$OBJCFLAGS__ax_save_flags
+
+
+  OBJCXXFLAGS=$OBJCXXFLAGS__ax_save_flags
+
+
+
       { $as_echo "$as_me:${as_lineno-$LINENO}: iconv found in default compiler location" >&5
 $as_echo "$as_me: iconv found in default compiler location" >&6;}
 
@@ -11105,7 +11118,7 @@ fi
 
     fi
 
-   if [ "$ICONV_CFLAGS" ]; then CFLAGS=$ICONV_CFLAGS;fi; if [ "$ICONV_CXXFLAGS" ]; then CXXFLAGS=$ICONV_CXXFLAGS;fi; if [ "$ICONV_CPPFLAGS" ]; then CPPFLAGS=$ICONV_CPPFLAGS;fi; if [ "$ICONV_LIBS" ]; then LIBS=$ICONV_LIBS;fi;
+   if [ "$ICONV_CFLAGS" ]; then CFLAGS=$ICONV_CFLAGS;fi; if [ "$ICONV_CXXFLAGS" ]; then CXXFLAGS=$ICONV_CXXFLAGS;fi; if [ "$ICONV_CPPFLAGS" ]; then CPPFLAGS=$ICONV_CPPFLAGS;fi;
 
   LC_MERGE_FLAGS_list="$ICONV_LDFLAGS"
   if [[ "LDFLAGS" =~ $(echo "(^|_)LIBS") ]]
@@ -12462,10 +12475,7 @@ fi
     ac_fn_cxx_check_header_mongrel "$LINENO" "iconv.h" "ac_cv_header_iconv_h" "$ac_includes_default"
 if test "x$ac_cv_header_iconv_h" = xyes; then :
 
-
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking iconv linking" >&5
-$as_echo_n "checking iconv linking... " >&6; }
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+      cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 #include <iconv.h>
 int
@@ -12477,9 +12487,8 @@ iconv_open("","");
 }
 _ACEOF
 if ac_fn_cxx_try_link "$LINENO"; then :
-
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
+  iconv
+else
 
 
   CFLAGS=$CFLAGS__ax_save_flags
@@ -13176,13 +13185,8 @@ fi
 
 $as_echo "#define USE_ICONV 1" >>confdefs.h
 
-
-
-else
-
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-    as_fn_error $? "Cannot use iconv.h." "$LINENO" 5
+        unset i_failure
+        unset LC_ICONV_LIBPATH
 
 fi
 rm -f core conftest.err conftest.$ac_objext \
@@ -13198,7 +13202,8 @@ fi
 else
 
     rm $LC_ICONV_TEMP
-    as_fn_error $? "Use with-iconv=iconv_base_path (i.e /usr/local) to specify your icon location.  Use with-iconv=no to ignore iconv." "$LINENO" 5
+    as_fn_error $? "use with-iconv=iconv_base_path (i.e /usr/local) to specify your icon location.
+Use with-iconv=no to ignore iconv." "$LINENO" 5
 
 fi
 
@@ -13232,7 +13237,6 @@ $as_echo "$as_me: ICONV_LDFLAGS:$ICONV_LDFLAGS" >&6;}
   ICONV_LDFLAGS=""
 
 
-unset ${!LC_ICONV_*}
 
 
 #--------------------------------------------------------------------
@@ -13663,7 +13667,7 @@ $as_echo "$as_me: WARNING: freetype-config not found" >&2;}
 
 
 
-   if [ "$FREETYPE_CFLAGS" ]; then CFLAGS=$FREETYPE_CFLAGS;fi; if [ "$FREETYPE_CXXFLAGS" ]; then CXXFLAGS=$FREETYPE_CXXFLAGS;fi; if [ "$FREETYPE_CPPFLAGS" ]; then CPPFLAGS=$FREETYPE_CPPFLAGS;fi; if [ "$FREETYPE_LIBS" ]; then LIBS=$FREETYPE_LIBS;fi;
+   if [ "$FREETYPE_CFLAGS" ]; then CFLAGS=$FREETYPE_CFLAGS;fi; if [ "$FREETYPE_CXXFLAGS" ]; then CXXFLAGS=$FREETYPE_CXXFLAGS;fi; if [ "$FREETYPE_CPPFLAGS" ]; then CPPFLAGS=$FREETYPE_CPPFLAGS;fi;
 
   LC_MERGE_FLAGS_list="$FREETYPE_LDFLAGS"
   if [[ "LDFLAGS" =~ $(echo "(^|_)LIBS") ]]
diff --git a/misc/m4/iconv.m4 b/misc/m4/iconv.m4
index 2c286ee..fa88c6f 100644
--- a/misc/m4/iconv.m4
+++ b/misc/m4/iconv.m4
@@ -13,7 +13,6 @@ then
 
   [$0]_PATH=$(echo ${LDFLAGS//\/lib/\/include})
   AX_SAVE_FLAGS
-  # try to find a header somewhere in this path and ask for its location
   CPPFLAGS="${[$0]_PATH//-L/-I} -I$withval/include -I/opt/local/include -I/sw/include -MM -MF $[$0]_TEMP"
 
   LC_CLEAR_FLAGS([ICONV]) # no previous iconv definition allowed
@@ -22,31 +21,33 @@ then
     [$0]_ICONV=${[$0]_DEPEND%/include/iconv.h*}
     if  @<:@@<:@ "$[$0]_DEPEND" == "$[$0]_ICONV" @:>@@:>@
     then
-      # don't add the default path to the LDFLAGS
+      AX_RESTORE_FLAGS
       AC_MSG_NOTICE([iconv found in default compiler location])
       LC_MERGE_FLAGS([-liconv],[ICONV_LIBS])
     else
-      [$0]_ICONV=${[$0]_ICONV@%:@@%:@* }
+      [$0]_ICONV=${[$0]_ICONV##* }
       AC_MSG_NOTICE([iconv found in $$0_ICONV])
       LC_SET_TRIVIAL_FLAGS([ICONV],[$$0_ICONV])
     fi
     LC_SET_FLAGS([ICONV])
     rm $[$0]_TEMP
     AC_CHECK_HEADER(iconv.h, [
-      LC_LINK_IFELSE([iconv],[AC_LANG_PROGRAM([[@%:@include <iconv.h>]],
-        [[iconv_open("",""); ]])],[
+      AC_LINK_IFELSE([AC_LANG_PROGRAM([[@%:@include <iconv.h>]],
+        [[iconv_open("",""); ]])],[iconv],[
         AX_RESTORE_FLAGS
         LC_COMBINE_FLAGS([ICONV])
         AC_DEFINE(USE_ICONV, 1, [Use iconv library])
+        unset i_failure
+        unset [$0]_LIBPATH
       ],[AC_MSG_ERROR([Cannot use iconv.h.])])
     ],[
       AC_MSG_ERROR([libiconv does not match header.])])
   ],[
     rm $[$0]_TEMP
-    AC_MSG_ERROR([Use with-iconv=iconv_base_path (i.e /usr/local) to specify your icon location.  Use with-iconv=no to ignore iconv.])
+    AC_MSG_ERROR([use with-iconv=iconv_base_path (i.e /usr/local) to specify your icon location.
+Use with-iconv=no to ignore iconv.])
   ],[-])
 else AC_MSG_WARN([absence of iconv may crash HTML import or prevent the build])
 fi
 LC_SUBST([ICONV])
-unset ${![$0]_*}
 ])
-- 
2.8.3

